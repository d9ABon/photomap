<!DOCTYPE html>
<html>
<head>
    <style >
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 90vh; }
        #actions {
            list-style: none;
            padding: 0;
        }
        #inline-actions {
            padding-top: 10px;
        }
        .item {
            margin-left: 20px;
        }
    </style>
</head>
<body>

<div id="map-container"><div id="map"></div></div>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-xPzxRusXhCjmhZsEMtIkT8NEJTdDsi0"></script><!-- async defer  -->
<script src="./examples/data.json"></script>
<script type="text/javascript" src="./markerclusterer.js"></script>
<script type="text/javascript" src="./styles.js"></script>


<div id="inline-actions">
      <span>Max zoom level:
        <select id="zoom">
          <option value="-1">Default</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14" selected="selected">14</option>
        </select>

      </span>
    <span class="item">Cluster size:
        <select id="size">
          <option value="-1">Default</option>
          <option value="40" selected="selected">40</option>
          <option value="50">50</option>
          <option value="70">70</option>
          <option value="80">80</option>
        </select>
      </span>
    <span class="item" style="display: none">Cluster style:
        <select id="style">
          <option value="-1">Default</option>
          <option value="0">People</option>
          <option value="1">Conversation</option>
          <option value="2">Heart</option>
          <option value="3">Pin</option>
       </select>
    </span>
       <input id="refresh" type="button" value="Refresh Map" class="item"/>
       <a href="#" id="clear">Clear</a>
</div>


<script type="text/javascript">
String.prototype.hashCode = function() {
    var hash = 0, i, chr, len;
    if (this.length === 0) return hash;
    for (i = 0, len = this.length; i < len; i++) {
        chr   = this.charCodeAt(i);
        hash  = ((hash << 5) - hash) + chr;
        hash |= 0; // Convert to 32bit integer
    }
    return hash;
};
//cache requests
$.ajaxPrefilter(function (options, originalOptions, jqXHR) {
    if (options.cache) {
        var success = originalOptions.success || $.noop,
            url = originalOptions.url;
        var hash = (url + JSON.stringify(originalOptions.data)).hashCode();

        options.cache = false; //remove jQuery cache as we have our own localStorage

        options.beforeSend = function (jqXHR, options) {
            var data = localStorage.getItem(hash);

            if (data) {
                if (originalOptions.dataType == 'json') {
                    data = JSON.parse(data);
                }
                setTimeout(function(){success(data);}, Math.round(Math.random() * 100));
                setTimeout(function(){jqXHR.success(data);}, Math.round(Math.random() * 100));
                return false;
            }
            return true;
        };
        options.success = function (data, textStatus) {
            if (originalOptions.dataType == 'json') {
                localStorage.setItem(hash, JSON.stringify(data));
            } else {
                localStorage.setItem(hash, data);
            }

            if ($.isFunction(success)) success(data); //call back to original ajax call
        };
    }
});


//https://github.com/googlemaps?language=javascript

var markerClusterer = null;
var map = null;

var api_key = 'c9f54b3e05dfaaca105f42bd1a1afd01';

function refreshMap() {
    $.ajax({
        'url': "https://api.flickr.com/services/rest/",
        'data': {
            'format': 'json',
            'nojsoncallback': 1,
            'bbox': decodeURIComponent('33.758754%2C44.598901%2C33.964576%2C44.695992'),
            'accuracy': 1,
            'sort': 'interestingness-desc',
            'extras': 'geo,url_t,url_m',
            'per_page': 250,
            'api_key': api_key,
            'method': 'flickr.photos.search'
        },
        'dataType': 'json',
        'cache': true,
        'success': onDataRecieved
    });
}
function onDataRecieved(data) {
    if (markerClusterer) {
        markerClusterer.clearMarkers();
    }

    var markers = [];

    var i, photo, markerImage;

    for (i = 0; i < data.photos.photo.length; i++) {
        photo = data.photos.photo[i];

        var latLng = new google.maps.LatLng(photo.latitude, photo.longitude);
        markerImage = new google.maps.MarkerImage(photo.url_t, new google.maps.Size(32, 32));
        var marker = new google.maps.Marker({
            position: latLng,
            draggable: false,
            icon: markerImage
        });
        markers.push(marker);
    }

    var zoom = parseInt(document.getElementById('zoom').value, 10);
    var size = parseInt(document.getElementById('size').value, 10);
    var style = parseInt(document.getElementById('style').value, 10);
    zoom = zoom === -1 ? null : zoom;
    size = size === -1 ? null : size;
    style = style === -1 ? null: style;

    //https://googlemaps.github.io/js-marker-clusterer/docs/reference.html
    markerClusterer = new MarkerClusterer(map, markers, {
        maxZoom: zoom,
        gridSize: size,
        styles: styles[style],
        imagePath: '../images/m',
        zoomOnClick: false
    });
}

function initialize() {

    //console.log(google.maps.MapTypeId);

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: new google.maps.LatLng(44.6023304, 33.8176695),
        mapTypeId: google.maps.MapTypeId.HYBRID
    });

    var refresh = document.getElementById('refresh');
    google.maps.event.addDomListener(refresh, 'click', refreshMap);

    var clear = document.getElementById('clear');
    google.maps.event.addDomListener(clear, 'click', clearClusters);

    refreshMap();
}

function clearClusters(e) {
    e.preventDefault();
    e.stopPropagation();
    markerClusterer.clearMarkers();
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>
</body>
</html>